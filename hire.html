<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Find a Writer - Handwritten Hub</title>
    <script src="firebase-config.js"></script>
    <style>
        :root {
            --primary: #2563eb;
            --bg: #f8fafc;
            --text: #1e293b;
        }
        body { font-family: 'Segoe UI', sans-serif; background: var(--bg); margin: 0; color: var(--text); }

        /* Header */
        header {
            background: white; padding: 1rem 2rem; border-bottom: 1px solid #e2e8f0;
            display: flex; justify-content: space-between; align-items: center;
        }
        .logo { font-weight: bold; font-size: 1.2rem; color: var(--primary); text-decoration: none; }

        /* Layout */
        .container {
            display: grid; grid-template-columns: 250px 1fr; gap: 30px;
            max-width: 1200px; margin: 2rem auto; padding: 0 1rem;
        }

        /* Sidebar Filters */
        .filters { background: white; padding: 1.5rem; border-radius: 10px; height: fit-content; }
        .filter-group { margin-bottom: 1.5rem; }
        .filter-title { font-weight: bold; margin-bottom: 0.5rem; display: block; }
        .price-range { width: 100%; }

        /* Grid */
        .results-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem; }
        .grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 20px; }

        /* Card */
        .card {
            background: white; border-radius: 10px; padding: 1rem; border: 1px solid #e2e8f0;
            transition: transform 0.2s;
        }
        .card:hover { transform: translateY(-5px); box-shadow: 0 10px 15px -3px rgba(0,0,0,0.1); }

        .card-head { display: flex; gap: 10px; align-items: center; margin-bottom: 10px; }
        .avatar { width: 40px; height: 40px; background: #cbd5e1; border-radius: 50%; background-size: cover; }
        .card-img { height: 120px; background: #f1f5f9; margin-bottom: 10px; border-radius: 5px; display: flex; align-items: center; justify-content: center; color: #94a3b8; font-size: 0.8rem; }
        
        .tag { background: #eff6ff; color: var(--primary); padding: 2px 8px; border-radius: 4px; font-size: 0.75rem; }

        .btn-view {
            width: 100%; padding: 0.5rem; margin-top: 10px; background: var(--text); color: white; border: none; border-radius: 5px; cursor: pointer;
        }
        .btn-view:hover { background: var(--primary); }
    </style>
</head>
<body>

    <header>
        <a href="index.html" class="logo">✍️ Handwritten Hub</a>
        <div>
            <span style="font-size: 0.9rem; margin-right: 10px;">Need it urgent?</span>
            <button style="background: #dc2626; color: white; border: none; padding: 5px 10px; border-radius: 5px; cursor: pointer;">Post Rush Job</button>
        </div>
    </header>

    <div class="container">
        <aside class="filters">
            <div class="filter-group">
                <span class="filter-title">Max Price per Page</span>
                <input type="range" class="price-range" min="5" max="50" value="50" oninput="updatePriceLabel(this.value); filterAndSort();">
                <div style="text-align: right; font-weight: bold; color: var(--primary);" id="priceVal">₹50</div>
            </div>
        </aside>

        <main>
            <div class="results-header">
                <h2 id="writerCount">Available Writers</h2>
                <select id="sortSelect" style="padding: 5px;" onchange="filterAndSort()">
                    <option value="rating">Sort by: Rating</option>
                    <option value="price">Sort by: Lowest Price</option>
                    <option value="delivery">Sort by: Fastest Delivery</option>
                </select>
            </div>

            <div id="loadingText">Loading writers from database...</div>
            <div class="grid" id="writersGrid">
                </div>
        </main>
    </div>
    <script>
        // Fetch writers when page loads
        window.onload = function() {
            setTimeout(fetchWriters, 1000); 
        };

        function fetchWriters() {
            db.collection('users')
              .where('role', '==', 'writer')
              .get()
              .then((querySnapshot) => {
                  const loadingEl = document.getElementById('loadingText');
                  if(loadingEl) loadingEl.style.display = 'none';
                  
                  let allWriters = [];
                  querySnapshot.forEach((doc) => {
                      allWriters.push(doc.data());
                  });

                  if(allWriters.length === 0) {
                      document.getElementById('writersGrid').innerHTML = "<p>No writers found.</p>";
                      return;
                  }

                  renderWriters(allWriters);
                  document.getElementById('writerCount').innerText = `Available Writers (${allWriters.length})`;
              });
        }

        function renderWriters(writers) {
            const grid = document.getElementById('writersGrid');
            grid.innerHTML = ''; // Clear current

            writers.forEach(writer => {
                // Parse Rate safely
                let priceNum = 15; // Default
                if(writer.rate) {
                    const matches = writer.rate.match(/(\d+)/);
                    if(matches) priceNum = parseInt(matches[0]);
                }

                // Default fallbacks
                const rating = writer.rating || 4.5;
                const reviews = writer.reviewCount || 0;
                const sampleImg = writer.sampleImage || '';

                const card = document.createElement('div');
                card.className = 'card';
                card.setAttribute('data-price', priceNum);
                card.setAttribute('data-rating', rating);
                card.setAttribute('data-delivery', 2); // Default for now
                
                card.innerHTML = `
                    <div class="card-head">
                        <div class="avatar" style="background-image: url('${writer.photoURL}')"></div>
                        <div>
                            <strong>${writer.name}</strong>
                            <div style="font-size: 0.8rem; color: #64748b;">${writer.college || 'Student'}</div>
                        </div>
                    </div>
                    <div class="card-img" style="background-image: url('${sampleImg}'); background-size: cover; background-position: center; color: transparent;"></div>
                    <div><span class="tag">Handwriting</span></div>
                    <h3 style="color: var(--primary); margin: 10px 0;">₹${priceNum} <small style="color:#666;">/page</small></h3>
                    <button class="btn-view" onclick="window.location.href='profile.html?uid=${writer.uid}'">View Profile</button>
                `;
                grid.appendChild(card);
            });
        }

        function updatePriceLabel(val) {
            document.getElementById('priceVal').innerText = '₹' + val;
        }

        function filterAndSort() {
            const priceMax = parseInt(document.querySelector('.price-range').value);
            const sortValue = document.getElementById('sortSelect').value;
            const grid = document.getElementById('writersGrid');
            const cards = Array.from(grid.getElementsByClassName('card'));
            let visibleCount = 0;

            // Filter
            cards.forEach(card => {
                const price = parseInt(card.getAttribute('data-price'));
                if (price <= priceMax) {
                    card.style.display = 'block';
                    visibleCount++;
                } else {
                    card.style.display = 'none';
                }
            });

            document.getElementById('writerCount').innerText = `Available Writers (${visibleCount})`;

            // Sort
            cards.sort((a, b) => {
                const priceA = parseInt(a.getAttribute('data-price'));
                const priceB = parseInt(b.getAttribute('data-price'));
                const ratingA = parseFloat(a.getAttribute('data-rating'));
                const ratingB = parseFloat(b.getAttribute('data-rating'));

                if (sortValue === 'price') return priceA - priceB;
                if (sortValue === 'rating') return ratingB - ratingA;
                return 0;
            }).forEach(card => grid.appendChild(card));
        }
    </script>
</body>
</html>
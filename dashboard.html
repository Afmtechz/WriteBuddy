<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Dashboard - WriteBuddy</title>
    <script src="firebase-config.js"></script> 
    <style>
        body { font-family: sans-serif; padding: 2rem; background: #f8fafc; }
        .container { max-width: 800px; margin: 0 auto; background: white; padding: 2rem; border-radius: 10px; }
        .tab-btn { padding: 10px 20px; cursor: pointer; border: none; background: #e2e8f0; }
        .tab-btn.active { background: #2563eb; color: white; }
        .hidden { display: none; }
    </style>
</head>
<body>
    <div class="container">
        <h1>Welcome, <span id="userName">User</span></h1>
        
        <div style="margin-bottom: 20px;">
            <button class="tab-btn active" onclick="showTab('orders')">My Orders</button>
            <button class="tab-btn" id="profileTabBtn" onclick="showTab('profile')" style="display:none">Edit Profile</button>
            <button class="tab-btn" onclick="auth.signOut().then(()=>window.location.href='index.html')">Log Out</button>
        </div>

        <div id="orders" class="tab-content">
            <h3>Your Orders</h3>
            <div id="ordersList">Loading...</div>
        </div>

        <div id="profile" class="tab-content hidden">
            <h3>Update Profile</h3>
            <label>Bio:</label><br>
            <textarea id="editBio" style="width:100%; height:100px;"></textarea><br><br>
            <button onclick="updateProfile()">Save Changes</button>
        </div>
    </div>

    <script>
        let currentUser = null;

        window.onload = () => {
            setTimeout(() => {
                auth.onAuthStateChanged(user => {
                    if(user) {
                        currentUser = user;
                        document.getElementById('userName').innerText = user.displayName || "User";
                        loadUserData(user.uid);
                    } else {
                        window.location.href = 'login.html';
                    }
                });
            }, 1000);
        };

        function showTab(tabId) {
            document.querySelectorAll('.tab-content').forEach(div => div.classList.add('hidden'));
            document.getElementById(tabId).classList.remove('hidden');
        }

        function loadUserData(uid) {
            db.collection('users').doc(uid).get().then(doc => {
                if (!doc.exists) return; // Should not happen if Login logic works
                
                const data = doc.data();
                
                // If user is a writer, show profile tab
                if (data.role === 'writer') {
                    document.getElementById('profileTabBtn').style.display = 'inline-block';
                    document.getElementById('editBio').value = data.bio || '';
                }

                loadOrders(uid, data.role || 'buyer');
            });
        }

        function updateProfile() {
            const newBio = document.getElementById('editBio').value;
            db.collection('users').doc(currentUser.uid).update({
                bio: newBio
            }).then(() => alert("Profile Updated!"));
        }

        function loadOrders(uid, role) {
            // Fetch orders where this user is buyer OR writer
            let queryField = role === 'writer' ? 'writerId' : 'buyerId';
            
            db.collection('orders').where(queryField, '==', uid).get().then(snaps => {
                const list = document.getElementById('ordersList');
                if(snaps.empty) { list.innerHTML = "No active orders."; return; }
                
                let html = '';
                snaps.forEach(doc => {
                    const order = doc.data();
                    html += `<div style="border:1px solid #ddd; padding:10px; margin-bottom:10px;">
                                <strong>Status: ${order.status}</strong><br>
                                Details: ${order.details}<br>
                                <small>Date: ${order.createdAt ? new Date(order.createdAt.seconds * 1000).toLocaleDateString() : 'N/A'}</small>
                             </div>`;
                });
                list.innerHTML = html;
            });
        }
    </script>
</body>
</html>
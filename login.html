<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Login - WriteBuddy</title>
     <script src="firebase-config.js"></script> 
    <style>
        :root {
            --primary: #2563eb;
            --secondary: #1e293b;
            --paper: #f8fafc;
        }

        body {
            font-family: 'Segoe UI', sans-serif;
            background-color: var(--paper);
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            margin: 0;
        }

        .auth-card {
            background: white;
            padding: 2.5rem;
            border-radius: 15px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.05);
            width: 100%;
            max-width: 350px;
            text-align: center;
        }

        .logo {
            font-size: 1.5rem;
            font-weight: bold;
            color: var(--primary);
            margin-bottom: 0.5rem;
            display: block;
            text-decoration: none;
        }

        .subtitle { color: #64748b; margin-bottom: 2rem; font-size: 0.9rem; }

        .tabs { display: flex; margin-bottom: 1.5rem; border-bottom: 2px solid #e2e8f0; }
        .tab { flex: 1; padding: 0.8rem; cursor: pointer; font-weight: 600; color: #94a3b8; transition: 0.3s; }
        .tab.active { color: var(--primary); border-bottom: 2px solid var(--primary); margin-bottom: -2px; }

        .btn-google {
            width: 100%;
            background: white;
            border: 1px solid #cbd5e1;
            border-radius: 8px;
            padding: 0.8rem;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            cursor: pointer;
            font-weight: 500;
            color: var(--secondary);
            transition: background 0.2s;
            margin-bottom: 1.5rem;
        }
        .btn-google:hover { background-color: #f1f5f9; }

        .divider { display: flex; align-items: center; color: #94a3b8; font-size: 0.8rem; margin: 1.5rem 0; }
        .divider::before, .divider::after { content: ""; flex: 1; height: 1px; background: #e2e8f0; }
        .divider span { padding: 0 10px; }

        .input-group { text-align: left; margin-bottom: 1rem; }
        .input-group label { display: block; font-size: 0.85rem; color: var(--secondary); margin-bottom: 5px; font-weight: 500; }
        .input-group input { width: 100%; padding: 0.8rem; box-sizing: border-box; border: 1px solid #cbd5e1; border-radius: 8px; font-size: 1rem; }

        .btn-submit {
            width: 100%; padding: 0.8rem; background-color: var(--primary); color: white; border: none; border-radius: 8px; font-size: 1rem; font-weight: 600; cursor: pointer; margin-top: 1rem;
        }
        .btn-submit:hover { background-color: #1d4ed8; }

        .form-section { display: none; }
        .form-section.active { display: block; }
        /* --- RESPONSIVE UPDATE FOR LOGIN.HTML --- */
@media (max-width: 400px) {
    .auth-card {
        padding: 1.5rem;
        width: 90%;
    }
    .logo { font-size: 1.2rem; }
}
    </style>
</head>
<body>

    <div class="auth-card">
        <a href="index.html" class="logo">✍️ WriteBuddy</a>
        <p class="subtitle">The marketplace for lazy students.</p>

        <div class="tabs">
            <div class="tab active" onclick="switchTab('login')">Log In</div>
            <div class="tab" onclick="switchTab('signup')">Sign Up</div>
        </div>

        <button class="btn-google" onclick="handleLogin('Google User')">
            <svg width="20" height="20" viewBox="0 0 24 24"><path d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z" fill="#4285F4"/><path d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z" fill="#34A853"/><path d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z" fill="#FBBC05"/><path d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z" fill="#EA4335"/></svg>
            Continue with Google
        </button>

        <div class="divider"><span>OR</span></div>

        <div id="login-form" class="form-section active">
            <div class="input-group">
                <label>College Email</label>
                <input type="email" id="loginEmail" placeholder="student@college.edu">
            </div>
            <div class="input-group">
                <label>Password</label>
                <input type="password" id="loginPassword" placeholder="••••••••">
            </div>
            <button class="btn-submit" onclick="handleLogin('Email')">Log In</button>
        </div>

        <div id="signup-form" class="form-section">
            <div class="input-group">
                <label>Full Name</label>
                <input type="text" id="signupName" placeholder="Rahul Sharma">
            </div>
            <div class="input-group">
                <label>College Email</label>
                <input type="email" id="signupEmail" placeholder="student@college.edu">
            </div>
            <div class="input-group">
                <label>Create Password</label>
                <input type="password" id="signupPassword" placeholder="••••••••">
            </div>
            <button class="btn-submit" onclick="handleSignup()">Create Account</button>
        </div>
    </div>

<script>
    // --- Tab Switching Logic ---
    function switchTab(tabName) {
        const loginForm = document.getElementById('login-form');
        const signupForm = document.getElementById('signup-form');
        const tabs = document.querySelectorAll('.tab');

        if (tabName === 'login') {
            loginForm.classList.add('active');
            signupForm.classList.remove('active');
            tabs[0].classList.add('active');
            tabs[1].classList.remove('active');
        } else {
            loginForm.classList.remove('active');
            signupForm.classList.add('active');
            tabs[0].classList.remove('active');
            tabs[1].classList.add('active');
        }
    }

    // --- REAL GOOGLE LOGIN & DB CREATION ---
    function handleLogin(providerName) {
        if (providerName === 'Google User') {
            const provider = new firebase.auth.GoogleAuthProvider();
            auth.signInWithPopup(provider)
                .then((result) => {
                    const user = result.user;
                    // Check if user exists in Firestore
                    const userRef = db.collection('users').doc(user.uid);
                    
                    userRef.get().then((doc) => {
                        if (!doc.exists) {
                            // First time Google login -> Create User Doc
                            return userRef.set({
                                uid: user.uid,
                                name: user.displayName,
                                email: user.email,
                                role: 'buyer', // Default role
                                joinedAt: firebase.firestore.FieldValue.serverTimestamp(),
                                photoURL: user.photoURL
                            });
                        }
                    }).then(() => {
                        saveUserLocally(user);
                    });
                })
                .catch((error) => {
                    alert("Error: " + error.message);
                });
        } else {
            // Email/Password Login
            const email = document.getElementById('loginEmail').value;
            const password = document.getElementById('loginPassword').value;

            auth.signInWithEmailAndPassword(email, password)
                .then((userCredential) => {
                    saveUserLocally(userCredential.user);
                })
                .catch((error) => {
                    alert("Login Failed: " + error.message);
                });
        }
    }

    // --- REAL SIGN UP ---
    function handleSignup() {
        const email = document.getElementById('signupEmail').value;
        const password = document.getElementById('signupPassword').value;
        const name = document.getElementById('signupName').value;

        auth.createUserWithEmailAndPassword(email, password)
            .then((userCredential) => {
                const user = userCredential.user;
                
                // Create User Document in Firestore
                db.collection('users').doc(user.uid).set({
                    uid: user.uid,
                    name: name,
                    email: email,
                    role: 'buyer', // Default role
                    joinedAt: firebase.firestore.FieldValue.serverTimestamp(),
                    photoURL: user.photoURL || `https://api.dicebear.com/7.x/avataaars/svg?seed=${name}`
                }).then(() => {
                    alert("✅ Account Created!");
                    saveUserLocally(user);
                });
            })
            .catch((error) => {
                alert("Signup Failed: " + error.message);
            });
    }

    // Helper to redirect after success
    function saveUserLocally(user) {
        const userData = {
            name: user.displayName || user.email.split('@')[0],
            email: user.email,
            photo: user.photoURL,
            uid: user.uid,
            isLoggedIn: true
        };
        
        localStorage.setItem('currentUser', JSON.stringify(userData));
        // Small delay to ensure DB write is acknowledged for Google Logins
        setTimeout(() => {
            window.location.href = 'index.html';
        }, 500);
    }
</script>
</body>

</html>

